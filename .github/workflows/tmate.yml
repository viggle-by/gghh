name: MacOS SSH + VNC + noVNC + Cloudflared

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          brew install tmate python3 cloudflared
          # Upgrade pip ignoring system package warning
          pip3 install --upgrade pip --break-system-packages
          # Install websockify for noVNC
          pip3 install websockify --break-system-packages

      - name: Enable macOS VNC (no username)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -users "" -privs -all -restart -agent -menu

          echo "secret" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent -menu

      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC

      - name: Start tmate session
        id: tmate
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          echo "SSH_CONNECTION=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')" >> $GITHUB_ENV
          echo "WEB_URL=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')" >> $GITHUB_ENV

      - name: Start noVNC WebSocket proxy
        run: |
          ~/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          echo "noVNC running on port 6080"

      - name: Start Cloudflare Tunnel (no authentication)
        run: |
          # Expose only noVNC via quick public tunnel
          cloudflared tunnel --url http://localhost:6080 --no-autoupdate &
          
          # Keep workflow alive so tunnel and noVNC stay running
          tail -f /dev/null

      - name: Show connection info
        run: |
          echo "Connect via SSH (tmate): $SSH_CONNECTION"
          echo "Connect via browser (tmate web): $WEB_URL"
          echo "VNC password: secret"
          echo "noVNC exposed via Cloudflare Tunnel (check workflow logs for URL)"
