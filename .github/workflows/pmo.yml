name: Colima with VS Code Tunnel

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------
      # Install Colima, VS Code CLI, Cloudflared
      # ----------------------
      - name: Install Colima, VS Code CLI, Cloudflared
        run: |
          brew update
          brew install colima cloudflared
          brew install --cask visual-studio-code

      # ----------------------
      # Start Colima via Homebrew Services
      # ----------------------
      - name: Start Colima with brew services
        run: |
          echo "Starting Colima via brew services..."
          brew services start colima
          echo "Colima started."

      # ----------------------
      # Start VS Code Tunnel
      # ----------------------
      - name: Start VS Code Tunnel
        run: |
          echo "Starting VS Code Tunnel..."
          # Accept CLI license automatically
          export PATH="/Applications/Visual Studio Code.app/Contents/Resources/app/bin:$PATH"

          # Start VS Code server in tunnel mode
          code tunnel --accept-server-license-terms &

      # ----------------------
      # Expose VS Code Tunnel port via Cloudflare (no token)
      # ----------------------
      - name: Expose VS Code Tunnel with Cloudflared (no token)
        run: |
          RANDOM_SUBDOMAIN="vscode-$(openssl rand -hex 4)"
          HOST="$RANDOM_SUBDOMAIN.trycloudflare.com"
          echo "cloud_subdomain=$HOST" >> $GITHUB_ENV

          echo "Starting Cloudflared tunnel..."
          cloudflared tunnel --url http://localhost:8080 --hostname "$HOST" &

          echo "============================================="
          echo " VS Code Tunnel is available (no authentication):"
          echo "   https://$HOST"
          echo "============================================="

      # ----------------------
      # Keep runner alive
      # ----------------------
      - name: Keep Alive
        run: tail -f /dev/null
